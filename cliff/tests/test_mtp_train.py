#!/usr/bin/env python

import cliff
from cliff.helpers.options import Options
from cliff.helpers.cell import Cell
from cliff.helpers.system import System
from cliff.atomic_properties.multipole_ml_bset import MultipoleMLBSet
import os
import pickle
import glob
import numpy as np

import cliff.tests as t
testpath = os.path.abspath(t.__file__).split('__init__')[0]

ca_ref = np.array([[ 3.56764869e-01, -7.99961726e-02, 1.96965580e-02,-2.85287115e-03, 
                    -3.16585165e-01, -9.50384478e-03, 1.04728082e-03,-9.50384478e-03,
                     1.82831884e-01,  3.63206077e-03, 1.04728082e-03, 3.63206077e-03,
                     1.33753282e-01],
                   [ 8.92307868e-03,  2.13653755e-02,-2.22774176e-02, 2.03115613e-02,
                     1.29294930e-02,  1.96067356e-02, 6.49927811e-02, 1.96067356e-02,
                     3.20597716e-02, -1.40207322e-02, 6.49927811e-02,-1.40207322e-02,
                    -4.49892647e-02],
                   [ 2.06602262e-01, -1.27685185e-01, 5.05820339e-02,-4.84365656e-03,
                     1.00101828e-01, -1.89749962e-01, 3.51703107e-02,-1.89749962e-01,
                    -1.30912108e-01,  3.85400368e-02, 3.51703107e-02, 3.85400368e-02,
                     3.08102800e-02],
                   [-1.30785763e-01, -3.57966951e-01,-2.94473079e-01,-1.46550566e-02,
                    -2.24825132e-01, -5.63277557e-01, 7.01387010e-02,-5.63277557e-01,
                     2.08798773e-01, -3.94951138e-02, 7.01387010e-02,-3.94951138e-02,
                     1.60263596e-02],
                   [-1.25609347e+00,  2.58352238e-01, 7.24570628e-01, 2.58765268e-01,
                    -2.44852891e+00, -1.74604576e-01,-1.88143001e-01,-1.74604576e-01,
                     8.57706468e-01,  4.24748669e-02,-1.88143001e-01, 4.24748669e-02,
                     1.59082245e+00],
                   [ 2.95970235e-01,  3.56226181e-01,-4.59215076e-02, 4.09092456e-01,
                    -9.96777438e-01, -5.58213525e-01, 2.03215185e-02,-5.58213525e-01,
                     1.51595783e-01, -3.96648297e-01, 2.03215185e-02,-3.96648297e-01,
                     8.45181655e-01],
                   [ 5.70703809e-01, -6.74433881e-02, 2.05593316e-01,-2.15608346e-02,
                     7.31798613e-02, -9.43447277e-02,-1.20524044e-02,-9.43447277e-02,
                     2.51530453e-02, -3.58582801e-02,-1.20524044e-02,-3.58582801e-02,
                    -9.83329066e-02],
                   [ 6.67858399e-03,  7.78960309e-03,-1.55187358e-02,-3.17209683e-01,
                    -1.41447361e-01,  1.45387445e-02, 1.27507891e-01, 1.45387445e-02,
                     4.64074739e-03,  5.04367564e-02, 1.27507891e-01, 5.04367564e-02,
                     1.36806614e-01],
                   [-4.95859096e-01,  1.40415453e-01,-1.33998460e-01,-1.77007063e-02,
                    -1.00276415e-01,  7.12014952e-02, 7.39537578e-02, 7.12014952e-02,
                     1.45942650e-01,  8.72067627e-03, 7.39537578e-02, 8.72067627e-03,
                    -4.56662353e-02],
                   [-3.28540191e-01,  3.09279073e-01, 3.61346350e-01, 1.15997759e-01,
                     9.67926291e-02,  7.24145025e-01, 2.48296410e-01, 7.24145025e-01,
                    -5.80755968e-01,  5.36774397e-02, 2.48296410e-01, 5.36774397e-02,
                     4.83963339e-01],
                   [ 1.74491053e+00, -6.06151133e-01,-1.01341286e-01, 3.36687347e-01,
                     8.78221362e-01, -1.67755363e-01,-2.99793155e-01,-1.67755363e-01,
                    -9.25032355e-01,  2.63702511e-02,-2.99793155e-01, 2.63702511e-02,
                     4.68109927e-02],
                   [ 4.06405436e-01, -5.22385085e-01,-2.69805203e-01, 9.71432096e-01,
                     3.83934768e-01,  1.67611363e+00, 4.45741739e-01, 1.67611363e+00,
                    -2.68546328e-01, -1.11044154e+00, 4.45741739e-01,-1.11044154e+00,
                    -1.15388440e-01],
                   [-5.69256410e-01,  2.20051303e-01,-1.00490518e-01,-1.45944760e-01,
                    -2.47043923e-01,  1.64790758e-01,-3.75972652e-03, 1.64790758e-01,
                     1.55056206e-01, -5.62305686e-02,-3.75972652e-03,-5.62305686e-02,
                     9.19877175e-02],
                   [ 1.16426786e-01, -7.31938905e-02, 2.69428053e-01, 1.28479858e-02,
                     6.08329595e-02, -9.18638828e-02,-6.76737135e-02,-9.18638828e-02,
                     1.39207995e-01,  1.09823332e-01,-6.76737135e-02, 1.09823332e-01,
                    -2.00040954e-01],
                   [ 4.06349216e-02, -1.15089269e-02,-1.18961772e-01, 1.07462175e-01,
                     4.49658466e-02, -4.03274594e-02,-2.70341009e-02,-4.03274594e-02,
                    -8.31971374e-05, -1.15574580e-01,-2.70341009e-02,-1.15574580e-01,
                    -4.48826495e-02],
                   [ 1.85429338e-01, -3.01813495e-02,-1.32305011e-01, 6.16164675e-02,
                    -2.17233933e-02,  1.11389567e-01,-4.52335022e-02, 1.11389567e-01,
                    -2.80910267e-02, -1.16593637e-01,-4.52335022e-02,-1.16593637e-01,
                     4.98144200e-02],
                   [-3.97798690e-01,  2.18734912e-02, 6.19520497e-02,-2.27226533e-02,
                     6.81742007e-02,  1.80634193e-02,-2.47132678e-02, 1.80634193e-02,
                    -1.35496459e-01,  2.09184470e-02,-2.47132678e-02, 2.09184470e-02,
                     6.73222581e-02],
                   [ 4.18894761e-01, -5.85434570e-02, 1.64496894e-02,-1.02504278e-01,
                    -4.28725612e-02, -9.70548360e-04, 6.20765112e-02,-9.70548360e-04,
                     7.91291129e-02,  5.03945331e-02, 6.20765112e-02, 5.03945331e-02,
                    -3.62565516e-02],
                   [ 3.13047618e-01, -8.06374698e-02, 1.05293229e-01, 2.62384575e-02,
                    -5.94788309e-02,  5.59481051e-02,-1.18977018e-01, 5.59481051e-02,
                    -1.60906211e-02, -5.19858750e-02,-1.18977018e-01,-5.19858750e-02,
                     7.55694520e-02],
                   [ 1.21161878e-01, -9.09746827e-02,-2.37956850e-01,-9.85208307e-02,
                     1.07487142e-01, -6.67360275e-02,-3.21908169e-01,-6.67360275e-02,
                     2.28802523e-01, -1.31609800e-02,-3.21908169e-01,-1.31609800e-02,
                    -3.36289666e-01],
                   [-2.70424562e-02,  4.67821768e-01,-7.15996816e-01,-5.95645618e-01,
                     1.53303999e+00,  4.09660586e-01, 4.85603326e-01, 4.09660586e-01,
                     3.83864041e-02, -6.62491607e-02, 4.85603326e-01,-6.62491607e-02,
                    -1.57142640e+00],
                   [-3.68132728e-01,  8.13903661e-02, 3.30890057e-01,-1.38277330e+00,
                     5.81879035e-01, -1.11818230e+00,-4.63975149e-01,-1.11818230e+00,
                     3.63605562e-02,  1.51549029e+00,-4.63975149e-01, 1.51549029e+00,
                    -6.18239591e-01],
                   [ 3.96247352e-01, -5.35825093e-02, 8.40196572e-02, 1.73872367e-01,
                     1.33703290e-01, -1.40594254e-01, 1.70629722e-02,-1.40594254e-01,
                    -2.06629045e-01,  1.00748418e-01, 1.70629722e-02, 1.00748418e-01,
                     7.29257548e-02],
                   [-2.80028757e-01, -2.58918019e+00, 1.93429769e+00,-2.28307783e+00,
                    -2.14824314e+00, -2.52698920e+00,-2.81650184e+00,-2.52698920e+00,
                     5.85251396e+00,  1.53252724e+00,-2.81650184e+00, 1.53252724e+00,
                    -3.70427082e+00],
                   [-1.20262008e-01,  5.19879647e-02, 3.12294912e-02, 6.13482373e-02,
                     1.09107164e-02, -8.73627088e-02,-6.91453744e-03,-8.73627088e-02,
                     5.66767692e-02, -3.21111600e-02,-6.91453744e-03,-3.21111600e-02,
                    -6.75874856e-02],
                   [ 1.60113947e-02, -3.18983590e-03, 2.64121012e-01,-5.35937433e-01,
                     8.96656563e-02,  1.31014125e-02, 5.82268056e-02, 1.31014125e-02,
                     1.92099946e-01,  4.44632428e-01, 5.82268056e-02, 4.44632428e-01,
                    -2.81765602e-01],
                   [ 1.33264883e-02,  2.50507440e-02,-4.35914162e-02,-4.95713316e-02,
                    -3.70512049e-02,  2.22372846e-02,-1.19313045e-02, 2.22372846e-02,
                    -9.03770267e-03, -3.59605125e-02,-1.19313045e-02,-3.59605125e-02,
                     4.60889076e-02],
                   [ 1.13155249e-01, -9.46114643e-02, 1.35248699e-02, 2.41530589e-01,
                     2.01559147e-01, -6.93935006e-02,-1.24588814e-01,-6.93935006e-02,
                    -1.03492127e-01, -2.75825621e-02,-1.24588814e-01,-2.75825621e-02,
                    -9.80670191e-02],
                   [ 6.69919955e-01, -3.25976026e-01,-3.91162989e-01, 1.58989308e+01,
                     6.14545523e-01,  2.96203403e-01,-7.15314404e+00, 2.96203403e-01,
                     5.10911678e-01,  7.71041467e-01,-7.15314404e+00, 7.71041467e-01,
                    -1.12545720e+00],
                   [-5.86858320e-01,  4.53593101e-02,-8.30086514e-03,-4.82461588e-02,
                     1.07604223e-02,  1.93658390e-02,-7.85180433e-03, 1.93658390e-02,
                     1.63195458e-02, -3.35882506e-03,-7.85180433e-03,-3.35882506e-03,
                    -2.70799680e-02],
                   [ 2.35073153e-01,  2.16536828e+00,-1.73962171e+00, 8.44372718e-01,
                     2.04519656e+00,  2.20314887e+00, 5.13963290e+00, 2.20314887e+00,
                    -5.09934886e+00, -1.96649397e+00, 5.13963290e+00,-1.96649397e+00,
                     3.05415230e+00],
                   [ 1.10345165e-01, -6.62613456e-02, 7.80751358e-03,-3.43909004e-02,
                     7.84803079e-03,  2.95904975e-02,-2.19607171e-02, 2.95904975e-02,
                    -2.23877460e-02,  3.27612856e-02,-2.19607171e-02, 3.27612856e-02,
                     1.45397152e-02],
                   [ 1.30711937e-02, -2.14688550e-02,-1.87766465e-01, 2.13469443e-01,
                    -1.76218049e-02,  2.06943919e-02,-6.36718944e-02, 2.06943919e-02,
                    -4.15507999e-02, -1.84737349e-01,-6.36718944e-02,-1.84737349e-01,
                     5.91726047e-02],
                   [-4.81325320e-02,  4.00841604e-02,-8.26656222e-03, 3.07360319e-02,
                    -2.22708390e-02,  1.27967446e-02, 4.07545767e-02, 1.27967446e-02,
                     3.14873997e-02, -1.86108375e-02, 4.07545767e-02,-1.86108375e-02,
                    -9.21656075e-03],
                   [-2.48276591e-01, -1.46982622e-03,-1.01155372e-02, 3.50262886e-01,
                    -1.11625452e-01, -1.31182218e-02, 2.80622898e-01,-1.31182218e-02,
                     4.07750767e-02,  1.27765640e-02, 2.80622898e-01, 1.27765640e-02,
                     7.08503755e-02],
                   [-5.66966115e-02, -6.34350240e-03,-1.63105664e-02, 1.71727191e-01,
                     2.73678888e-03,  4.29878731e-02, 5.78713977e-02, 4.29878731e-02,
                    -1.15923498e-02, -5.43493772e-02, 5.78713977e-02,-5.43493772e-02,
                     8.85556091e-03],
                   [-3.20565740e-01,  4.66751191e-01, 6.11476827e-01,-7.66887415e+00,
                    -7.27337442e-01,  2.43082746e-01, 2.42535443e+00, 2.43082746e-01,
                    -6.83885891e-01, -1.15717031e+00, 2.42535443e+00,-1.15717031e+00,
                     1.41122333e+00],
                   [-1.74727189e-01,  1.15298471e-01,-5.49205220e-02, 1.55217753e-01,
                     1.79465503e-01, -2.48130250e-01,-5.13566492e-01,-2.48130250e-01,
                    -1.88845436e-01, -7.66174176e-02,-5.13566492e-01,-7.66174176e-02,
                     9.37993279e-03],
                   [ 5.23747603e-01, -2.52258975e-02,-1.82328235e-02,-1.33000171e-01,
                     3.29927647e-03,  5.89616364e-03,-6.73717066e-02, 5.89616364e-03,
                    -7.26971710e-02,  5.85503291e-02,-6.73717066e-02, 5.85503291e-02,
                     6.93978945e-02],
                   [-2.51575347e-01,  4.63021093e-01,-2.07429855e-01, 1.19461450e+00,
                    -5.77076700e-02,  5.95220052e-01,-2.08777055e+00, 5.95220052e-01,
                    -5.17150895e-01,  4.38481967e-01,-2.08777055e+00, 4.38481967e-01,
                     5.74858565e-01],
                   [ 3.09609164e-01,  2.80758496e-02,-8.05896038e-03,-7.50154938e-03,
                    -5.09414597e-02, -1.13690894e-02, 3.93182964e-03,-1.13690894e-02,
                    -3.39466757e-02, -2.04979934e-04, 3.93182964e-03,-2.04979934e-04,
                     8.48881354e-02],
                   [-3.34238045e-02, -1.71541437e-02,-1.90662021e-01, 2.02837923e-01,
                    -9.23274342e-03, -3.62706528e-02, 6.72092470e-03,-3.62706528e-02,
                    -9.22151676e-02, -2.74040882e-01, 6.72092470e-03,-2.74040882e-01,
                     1.01447911e-01],
                   [ 1.46903904e-01,  3.22594078e-02,-1.33204642e-02,-2.99408729e-02,
                    -8.51987012e-02, -1.91311719e-02, 3.74730352e-02,-1.91311719e-02,
                    -2.95224753e-02,  4.35493877e-02, 3.74730352e-02, 4.35493877e-02,
                     1.14721177e-01],
                   [-1.15232149e-01,  4.19913912e-02,-4.14326316e-02,-3.28571048e-01,
                     4.18069354e-02,  9.91030750e-02,-2.39087076e-01, 9.91030750e-02,
                     3.68724450e-04,  1.55814083e-02,-2.39087076e-01, 1.55814083e-02,
                    -4.21756599e-02],
                   [ 8.86336294e-02,  2.54424062e-02,-1.46834233e-02,-1.42433385e-01,
                     3.69853920e-02,  5.94586011e-02,-4.55009190e-02, 5.94586011e-02,
                    -1.21256184e-01,  9.26834827e-02,-4.55009190e-02, 9.26834827e-02,
                     8.42707922e-02],
                   [-1.57519933e-01, -2.09939293e-01,-1.79510932e-01,-8.09517370e+00,
                     1.52008602e-01, -5.42374309e-01, 4.69190357e+00,-5.42374309e-01,
                     8.45342935e-02,  3.32785945e-01, 4.69190357e+00, 3.32785945e-01,
                    -2.36542895e-01],
                   [-2.27916321e-01, -3.59846328e-02, 5.31891630e-02,-3.58889076e-02,
                    -5.72845852e-02, -5.90642064e-02, 3.34252998e-01,-5.90642064e-02,
                     4.12280873e-02,  8.59408833e-02, 3.34252998e-01, 8.59408833e-02,
                     1.60564979e-02],
                   [ 6.47476812e-01,  4.12237547e-02, 3.56532455e-03, 1.19174481e-01,
                    -5.53312745e-02,  2.98457069e-02, 4.46584184e-02, 2.98457069e-02,
                    -8.76761358e-02, -8.72491671e-02, 4.46584184e-02,-8.72491671e-02,
                     1.43007410e-01]])



def test_ml_mtp():
    """Train machine learning on data set"""
    options = Options(testpath + '/mtp_train/config.ini') 
    mtp_model = MultipoleMLBSet(options, descriptor="slatm")
    # Load mbtypes
    with open(testpath + "/../models/mbtypes.pkl", 'rb') as f:
        mtp_model.mbtypes = pickle.load(f)

    ele_set = set([])

    xyz_training = sorted(glob.glob(testpath + "mtp_train/xyzs/*.xyz"))
    mtp_training = sorted(glob.glob(testpath + "mtp_train/mtps/*.txt"))

    for xyz,mtp in zip(xyz_training, mtp_training):

        mol1 = System(options, xyz)
        mtp_model.add_mol_to_training(mol1, mtp, atom='C', xyz=xyz)
    mtp_model.train_mol()

    c_alpha = mtp_model.alpha_train['C']

    res = np.square(np.subtract(c_alpha,ca_ref))
    res = np.sum(res)
    
    assert res < 1e-12


    
    

